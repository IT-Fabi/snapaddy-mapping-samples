{
    "dynamics": {
        "meta": {
            "lead": {
                "apiName": "Lead",
                "idProperty": "LeadId",
                "logicalName": "lead"
            },
            "contact": {
                "apiName": "Contact",
                "idProperty": "ContactId",
                "logicalName": "contact"
            },
            "account": {
                "apiName": "Account",
                "idProperty": "AccountId",
                "logicalName": "account"
            },
            "appointment": {
                "apiName": "Appointment",
                "idProperty": "ActivityId",
                "logicalName": "appointment"
            },
            "task": {
                "apiName": "Task",
                "idProperty": "ActivityId",
                "logicalName": "task"
            }
        },
        "defaultExport": {
            "mappings": {
                "lead": {
                    "Subject": "{{ topic }}",
                    "FirstName": "{{ firstName }}",
                    "LastName": "{{ lastName }}",
                    "Salutation": "{{ gender == -1? ('') : (gender == 0? ('Herr') : ('Frau')) }}",
                    "JobTitle": "{{ position }}",
                    "CompanyName": "{{ organization }}",
                    "WebSiteUrl": "{{ website }}",
                    "EMailAddress1": "{{ email }}",
                    "Telephone1": "{{ phone }}",
                    "MobilePhone": "{{ mobile }}",
                    "Fax": "{{ fax }}",
                    "Address1_Line1": "{{ street }}",
                    "Address1_City": "{{ city }}",
                    "Address1_PostalCode": "{{ zip }}",
                    "Address1_Country": "{{ country }}",
                    "Address1_StateOrProvince": "{{ state }}"
                },
                "contact": {
                    "FirstName": "{{ firstName }}",
                    "LastName": "{{ lastName }}",
                    "Salutation": "{{ gender == -1? ('') : (gender == 0? ('Herr') : ('Frau')) }}",
                    "JobTitle": "{{ position }}",
                    "MobilePhone": "{{ mobile }}",
                    "Fax": "{{ fax }}",
                    "Telephone1": "{{ phone }}",
                    "WebSiteUrl": "{{ website }}",
                    "EMailAddress1": "{{ email }}",
                    "Address1_Line1": "{{ street }}",
                    "Address1_City": "{{ city }}",
                    "Address1_PostalCode": "{{ zip }}",
                    "Address1_Country": "{{ country }}",
                    "Address1_StateOrProvince": "{{ state }}",
                    "GenderCode": {
                        "Value": "{{ execute(genderMapping) }}"
                    }
                },
                "account": {
                    "Name": "{{ organization }}",
                    "WebSiteURL": "{{ website }}",
                    "Telephone1": "{{ phone }}",
                    "Fax": "{{ fax }}",
                    "Address1_Line1": "{{ street }}",
                    "Address1_PostalCode": "{{ zip }}",
                    "Address1_City": "{{ city }}",
                    "Address1_Country": "{{ country }}",
                    "Address1_StateOrProvince": "{{ state }}"
                }
            },
            "workflows": {
                "lead": [
                    {
                        "entity": "lead"
                    },
                    {
                        "entity": "appointment",
                        "dependsOn": [
                            {
                                "field": "RegardingObjectId",
                                "entity": "lead"
                            }
                        ]
                    },
                    {
                        "entity": "task",
                        "dependsOn": [
                            {
                                "field": "RegardingObjectId",
                                "entity": "lead"
                            }
                        ]
                    },
                    {
                        "entity": "attachments",
                        "config": {
                            "drawing": {
                                "entities": [
                                    "lead"
                                ],
                                "name": "Drawing.png"
                            },
                            "bcImage": {
                                "entities": [
                                    "lead"
                                ],
                                "name": "VCard front.png"
                            },
                            "bcImageBackside": {
                                "entities": [
                                    "lead"
                                ],
                                "name": "VCard back.png"
                            },
                            "attachments": {
                                "entities": [
                                    "lead"
                                ],
                                "name": {
                                    "*": "Attachment_${i}.png",
                                    "PDF": "Attachment_${i}.pdf",
                                    "SIGNATURE": "{{visitreport.title || '' }} - {{firstName || '' }} {{lastName || ''}} Signatur (${i}).pdf"
                                }
                            },
                            "note": {
                                "entities": [
                                    "lead"
                                ],
                                "name": "Note"
                            }
                        }
                    }
                ],
                "contact_account": [
                    {
                        "entity": "account"
                    },
                    {
                        "entity": "contact",
                        "dependsOn": [
                            {
                                "field": "ParentCustomerId",
                                "entity": "account"
                            }
                        ]
                    },
                    {
                        "entity": "appointment",
                        "dependsOn": [
                            {
                                "field": "RegardingObjectId",
                                "entity": "contact"
                            }
                        ]
                    },
                    {
                        "entity": "task",
                        "dependsOn": [
                            {
                                "field": "RegardingObjectId",
                                "entity": "contact"
                            }
                        ]
                    },
                    {
                        "entity": "attachments",
                        "config": {
                            "drawing": {
                                "entities": [
                                    "contact"
                                ],
                                "name": "Drawing.png"
                            },
                            "bcImage": {
                                "entities": [
                                    "contact"
                                ],
                                "name": "VCard front.png"
                            },
                            "bcImageBackside": {
                                "entities": [
                                    "contact"
                                ],
                                "name": "VCard back.png"
                            },
                            "attachments": {
                                "entities": [
                                    "contact"
                                ],
                                "name": {
                                    "*": "Attachment_${i}.png",
                                    "PDF": "Attachment_${i}.pdf",
                                    "SIGNATURE": "{{visitreport.title || '' }} - {{firstName || '' }} {{lastName || ''}} Signatur (${i}).pdf"
                                }
                            },
                            "note": {
                                "entities": [
                                    "contact"
                                ],
                                "name": "Note"
                            }
                        }
                    }
                ]
            },
            "components": {
                "lead": [],
                "contact_account": []
            }
        },
        "visitreport": {
            "mappings": {
                "*": {
                    "lead": {
                        "Salutation": "{{ gender == -1? ('') : (gender == 0? ('Herr') : ('Frau')) }}",
                        "Subject": "{{ topic }}",
                        "FirstName": "{{ firstName }}",
                        "LastName": "{{ lastName }}",
                        "JobTitle": "{{ position }}",
                        "CompanyName": "{{ organization }}",
                        "WebSiteUrl": "{{ website }}",
                        "EMailAddress1": "{{ email }}",
                        "Telephone1": "{{ phone }}",
                        "MobilePhone": "{{ mobile }}",
                        "Fax": "{{ fax }}",
                        "Address1_Line1": "{{ street }}",
                        "Address1_City": "{{ city }}",
                        "Address1_PostalCode": "{{ zip }}",
                        "Address1_Country": "{{ country }}",
                        "Address1_StateOrProvince": "{{ state }}"
                    },
                    "contact": {
                        "Salutation": "{{ gender == -1? ('') : (gender == 0? ('Herr') : ('Frau')) }}",
                        "FirstName": "{{ firstName }}",
                        "LastName": "{{ lastName }}",
                        "JobTitle": "{{ position }}",
                        "MobilePhone": "{{ mobile }}",
                        "Fax": "{{ fax }}",
                        "Telephone1": "{{ phone }}",
                        "WebSiteUrl": "{{ website }}",
                        "EMailAddress1": "{{ email }}",
                        "Address1_Line1": "{{ street }}",
                        "Address1_City": "{{ city }}",
                        "Address1_PostalCode": "{{ zip }}",
                        "Address1_Country": "{{ country }}",
                        "Address1_StateOrProvince": "{{ state }}",
                        "GenderCode": {
                            "Value": "{{ execute(genderMapping) }}"
                        },
                        "ParentCustomerId": {
                            "Id": "{{ _account.AccountId }}",
                            "LogicalName": "account"
                        }
                    },
                    "account": {
                        "Name": "{{ organization }}",
                        "WebSiteURL": "{{ website }}",
                        "Telephone1": "{{ phone }}",
                        "Fax": "{{ fax }}",
                        "Address1_Line1": "{{ street }}",
                        "Address1_PostalCode": "{{ zip }}",
                        "Address1_City": "{{ city }}",
                        "Address1_Country": "{{ country }}",
                        "Address1_StateOrProvince": "{{ state }}"
                    },
                    "note": {
                        "note": "{{ execute(getVisitReportNote) }}"
                    }
                }
            },
            "workflows": {
                "*": {
                    "lead": [
                        {
                            "entity": "lead"
                        },
                        {
                            "entity": "appointment",
                            "dependsOn": [
                                {
                                    "field": "RegardingObjectId",
                                    "entity": "lead"
                                }
                            ]
                        },
                        {
                            "entity": "task",
                            "dependsOn": [
                                {
                                    "field": "RegardingObjectId",
                                    "entity": "lead"
                                }
                            ]
                        },
                        {
                            "entity": "attachments",
                            "config": {
                                "drawing": {
                                    "entities": [
                                        "lead"
                                    ],
                                    "name": "Drawing.png"
                                },
                                "bcImage": {
                                    "entities": [
                                        "lead"
                                    ],
                                    "name": "VCard front.png"
                                },
                                "bcImageBackside": {
                                    "entities": [
                                        "lead"
                                    ],
                                    "name": "VCard back.png"
                                },
                                "attachments": {
                                    "entities": [
                                        "lead"
                                    ],
                                    "name": {
                                        "*": "Attachment_${i}.png",
                                        "PDF": "Attachment_${i}.pdf",
                                        "SIGNATURE": "{{visitreport.title || '' }} - {{firstName || '' }} {{lastName || ''}} Signatur (${i}).pdf"
                                    }
                                },
                                "note": {
                                    "entities": [
                                        "lead"
                                    ],
                                    "name": "Note"
                                }
                            }
                        }
                    ],
                    "contact_account": [
                        {
                            "entity": "account"
                        },
                        {
                            "entity": "contact",
                            "dependsOn": [
                                {
                                    "field": "ParentCustomerId",
                                    "entity": "account"
                                }
                            ]
                        },
                        {
                            "entity": "appointment",
                            "dependsOn": [
                                {
                                    "field": "RegardingObjectId",
                                    "entity": "contact"
                                }
                            ]
                        },
                        {
                            "entity": "task",
                            "dependsOn": [
                                {
                                    "field": "RegardingObjectId",
                                    "entity": "contact"
                                }
                            ]
                        },
                        {
                            "entity": "attachments",
                            "config": {
                                "drawing": {
                                    "entities": [
                                        "contact"
                                    ],
                                    "name": "Drawing.png"
                                },
                                "bcImage": {
                                    "entities": [
                                        "contact"
                                    ],
                                    "name": "VCard front.png"
                                },
                                "bcImageBackside": {
                                    "entities": [
                                        "contact"
                                    ],
                                    "name": "VCard back.png"
                                },
                                "attachments": {
                                    "entities": [
                                        "contact"
                                    ],
                                    "name": {
                                        "*": "Attachment_${i}.png",
                                        "PDF": "Attachment_${i}.pdf",
                                        "SIGNATURE": "{{visitreport.title || '' }} - {{firstName || '' }} {{lastName || ''}} Signatur (${i}).pdf"
                                    }
                                },
                                "note": {
                                    "entities": [
                                        "contact"
                                    ],
                                    "name": "Note"
                                }
                            }
                        }
                    ]
                }
            },
            "components": {
                "*": {
                    "lead": [],
                    "contact_account": []
                }
            }
        },
        "code": {
            "functions": {
                "genderMapping": [
                    "  if (address.gender === 0) { return 1; }",
                    "  if (address.gender === 1) { return 2; }",
                    "  return null;                           "
                ],
                "getVisitReportNote": [
                    "var note = address.note || '';",
                    "if (address.visitreport && address.visitreport.result) {",
                    "  note += '\\n\\nVisitReport\\n\\n';",
                    "  var result = address.visitreport.result;",
                    "  for (var key in result) {",
                    "    note += result[key].question + ' = ' + result[key].text + '\n';",
                    "  }",
                    "}",
                    "return note.replace(/\"/g,'\\\\\"');"
                ]
            }
        },
        "duplicateCheck": {
          "settings": {},
          "pipeline": {
            "stages": [
              {
                "tasks": [
                  {
                    "entity": "lead",
                    "tree": {
                      "operator": "or",
                      "subconditions": [
                        {
                          "field": "EMailAddress1",
                          "operator": "allIn",
                          "value": "{{address.email}}",
                          "filters": [
                            "return !isEmailGeneric(address.email)"
                          ]
                        },
                        {
                          "operator": "and",
                          "subconditions": [
                            {
                              "field": "FirstName",
                              "operator": "allIn",
                              "value": "{{address.firstName}}"
                            },
                            {
                              "field": "LastName",
                              "operator": "allIn",
                              "value": "{{address.lastName}}"
                            },
                            {
                              "field": "CompanyName",
                              "operator": "allIn",
                              "value": "{{address.organization}}"
                            }
                          ],
                          "filters": [
                            "return (address.firstName.length >= 3 || address.lastName.length >= 3) && address.organization.length >= 3"
                          ]
                        }
                      ]
                    }
                  },
                  {
                    "entity": "contact",
                    "tree": {
                      "operator": "or",
                      "subconditions": [
                        {
                          "field": "EMailAddress1",
                          "operator": "allIn",
                          "value": "{{address.email}}",
                          "filters": [
                            "return !isEmailGeneric(address.email)"
                          ]
                        },
                        {
                          "operator": "and",
                          "subconditions": [
                            {
                              "field": "FirstName",
                              "operator": "allIn",
                              "value": "{{address.firstName}}"
                            },
                            {
                              "field": "LastName",
                              "operator": "allIn",
                              "value": "{{address.lastName}}"
                            }
                          ],
                          "filters": [
                            "return address.firstName.length >= 3 || address.lastName.length >= 3"
                          ]
                        }
                      ]
                    }
                  },
                  {
                    "entity": "account",
                    "tree": {
                      "operator": "OR",
                      "subconditions": [
                        {
                          "field": "WebSiteURL",
                          "operator": "allIn",
                          "value": "{{address.website}}",
                          "filters": [
                            "return (getDomainFromURL(address.website) || '').length >= 3"
                          ]
                        },
                        {
                          "field": "Name",
                          "operator": "allIn",
                          "value": "{{address.organization}}",
                          "filters": [
                            "return address.organization.length >= 3"
                          ]
                        }
                      ]
                    }
                  }
                ],
                "results": [],
                "post": [
                  [
                    "var sorted = pipeline.stages[0].results[0].duplicates;",
                    "for (var i = 0; i < sorted.length; i++) {",
                    " var e = sorted[i];",
                    " e._sortKey = 0;",
                    " if (e.FullName.toLowerCase().indexOf(address.firstName.toLowerCase()) > -1) {",
                    "   e._sortKey++;",
                    " }",
                    " if (e.FullName.toLowerCase().indexOf(address.lastName.toLowerCase()) > -1) {",
                    "   e._sortKey++;",
                    " }",
                    " if ((e.Company || '').trim().toLowerCase().indexOf(address.organization.toLowerCase()) > -1) {",
                    "   e._sortKey = e._sortKey + 3;",
                    " }",
                    "}",
                    "sorted.sort(function(a, b) { return a._sortKey > b._sortKey ? -1 : 1 });",
                    "pipeline.stages[0].results[0].duplicates = sorted;",
                    "pipeline.stages[0].results[0].suggested = sorted[0];",
                    "return pipeline;"
                  ],
                  [
                    "var sorted = pipeline.stages[0].results[1].duplicates;",
                    "for (var i = 0; i < sorted.length; i++) {",
                    " var e = sorted[i];",
                    " e._sortKey = 0",
                    " if (e.FullName.toLowerCase().indexOf(address.firstName.toLowerCase()) > -1) {",
                    "   e._sortKey++;",
                    " }",
                    " if (e.FullName.toLowerCase().indexOf(address.lastName.toLowerCase()) > -1) {",
                    "   e._sortKey++;",
                    " }",
                    " if ((e.Company || '').trim().toLowerCase().indexOf(address.organization.toLowerCase()) > -1) {",
                    "   e._sortKey = e._sortKey + 3;",
                    " }",
                    "}",
                    "sorted.sort(function(a, b) { return a._sortKey > b._sortKey ? -1 : 1 });",
                    "pipeline.stages[0].results[1].duplicates = sorted;",
                    "pipeline.stages[0].results[1].suggested = sorted[0];",
                    "return pipeline;"
                  ],
                  [
                    "var sorted = pipeline.stages[0].results[2].duplicates;",
                    "for (var i = 0; i < sorted.length; i++) {",
                    " var e = sorted[i];",
                    " e._sortKey = 0",
                    " if ((e.Company || '').toLowerCase().indexOf(address.organization) > -1) {",
                    "   e._sort_key += 3",
                    " }",
                    " if (e.Address1_PostalCode === address.zip || e.Address1_City === address.city) {",
                    "   e._sortKey += 2;",
                    " } else if (e.Address1_PostalCode || e.Address1_City) {",
                    "   e._sortKey += 1;",
                    " }",
                    "}",
                    "sorted.sort(function(a, b) { return a._sortKey > b._sortKey ? -1 : 1 });",
                    "pipeline.stages[0].results[2].duplicates = sorted;",
                    "pipeline.stages[0].results[2].suggested = sorted[0];",
                    "return pipeline;"
                  ]
                ]
              }
            ],
            "mapResults": [
              "return {",
              "  lead: pipeline.stages[0].results[0],",
              "  contact: pipeline.stages[0].results[1],",
              "  account: pipeline.stages[0].results[2],",
              "}"
            ]
          }
        }
    }
}
